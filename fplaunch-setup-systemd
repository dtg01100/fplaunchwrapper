#!/usr/bin/env bash

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source common utilities
if [ -f "$SCRIPT_DIR/lib/common.sh" ]; then
    # shellcheck source=lib/common.sh
    source "$SCRIPT_DIR/lib/common.sh"
elif [ -f "${SCRIPT_DIR%/bin}/lib/common.sh" ]; then
    # When installed, lib is relative to bin parent
    # shellcheck source=lib/common.sh
    source "${SCRIPT_DIR%/bin}/lib/common.sh"
else
    echo "ERROR: Cannot find common.sh library" >&2
    echo "Searched in:" >&2
    echo "  - $SCRIPT_DIR/lib/common.sh" >&2
    echo "  - ${SCRIPT_DIR%/bin}/lib/common.sh" >&2
    exit 1
fi

init_paths
WRAPPER_SCRIPT="$SCRIPT_DIR/fplaunch-generate"
UNIT_DIR=$(get_systemd_unit_dir)
    # Detect Flatpak installation directory dynamically
    if [ -d "$HOME/.local/share/flatpak/exports/bin" ]; then
        FLATPAK_BIN_DIR="$HOME/.local/share/flatpak/exports/bin"
    elif [ -d "/var/lib/flatpak/exports/bin" ]; then
        FLATPAK_BIN_DIR="/var/lib/flatpak/exports/bin"
    elif command -v flatpak >/dev/null 2>&1; then
        # Try to get from flatpak itself
        FLATPAK_BIN_DIR=$(dirname "$(command -v flatpak | awk '{print $3}')")
    else
        echo "Warning: Could not detect Flatpak bin directory, using default"
        FLATPAK_BIN_DIR="$HOME/.local/share/flatpak/exports/bin"
    fi

# Check prerequisites
systemd_available=false
if command -v systemctl &> /dev/null && systemctl --user status &> /dev/null; then
    systemd_available=true
fi

if ! command -v flatpak &> /dev/null; then
    echo "Error: Flatpak not installed."
    exit 1
fi

if [ ! -f "$WRAPPER_SCRIPT" ]; then
    echo "Error: Wrapper script not found at $WRAPPER_SCRIPT"
    exit 1
fi

mkdir -p "$UNIT_DIR"

# Create service unit
cat > "$UNIT_DIR/flatpak-wrappers.service" << EOF
[Unit]
Description=Generate Flatpak wrapper scripts

[Service]
Type=oneshot
ExecStart=$WRAPPER_SCRIPT $BIN_DIR
EOF

# Create path unit for automatic triggering
cat > "$UNIT_DIR/flatpak-wrappers.path" << EOF
[Unit]
Description=Watch for Flatpak app changes

[Path]
PathChanged=$FLATPAK_BIN_DIR
Unit=flatpak-wrappers.service

[Install]
WantedBy=default.target
EOF

# Create timer unit for periodic run
cat > "$UNIT_DIR/flatpak-wrappers.timer" << EOF
[Unit]
Description=Timer for Flatpak wrapper generation

[Timer]
OnCalendar=daily
Persistent=true

[Install]
WantedBy=timers.target
EOF

if [ "$systemd_available" = true ]; then
    # Reload and enable
    systemctl --user daemon-reload
    systemctl --user enable flatpak-wrappers.path
    systemctl --user start flatpak-wrappers.path
    systemctl --user enable flatpak-wrappers.timer
    systemctl --user start flatpak-wrappers.timer
    echo "Systemd units installed and started. Wrappers will update automatically on user Flatpak changes and daily (system Flatpak changes require manual run or wait for timer)."
else
    # Fallback to cron
    if command -v crontab &> /dev/null; then
        cron_job="0 */6 * * * $WRAPPER_SCRIPT $BIN_DIR"
        if ! crontab -l 2>/dev/null | grep -q "$WRAPPER_SCRIPT"; then
            (crontab -l 2>/dev/null; echo "$cron_job") | crontab -
            echo "Cron job added for wrapper updates every 6 hours. (System Flatpak changes require manual run.)"
        else
            echo "Cron job already exists. Wrappers will update every 6 hours."
        fi
    else
        echo "Neither systemd nor crontab available. Please run '$WRAPPER_SCRIPT $BIN_DIR' manually to update wrappers."
    fi
fi