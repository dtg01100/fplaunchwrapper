name: CI

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]

jobs:
  shellcheck:
    name: ShellCheck Linting
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Run ShellCheck
      uses: ludeeus/action-shellcheck@master
      with:
        scandir: '.'
        severity: warning
        ignore_paths: '.git .github tests/fixtures'
        ignore_names: 'README.md'

  test-ubuntu:
    name: Test on Ubuntu
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y flatpak dialog
        sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
    
    - name: Run test suite
      run: |
        cd tests
        bash run_all_tests.sh
    
    - name: Test installation
      run: |
        bash install.sh
        # Verify installation
        test -f ~/.local/bin/fplaunch-manage
        test -f ~/.local/bin/fplaunch-generate
        test -f ~/.local/bin/fplaunch-setup-systemd
    
    - name: Test management commands
      run: |
        ~/.local/bin/fplaunch-manage --help
        ~/.local/bin/fplaunch-manage list
        ~/.local/bin/fplaunch-manage list-blocked

  test-fedora:
    name: Test on Fedora
    runs-on: ubuntu-latest
    container:
      image: fedora:latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        dnf install -y flatpak dialog bash
        flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
    
    - name: Run test suite
      run: |
        cd tests
        bash run_all_tests.sh
    
    - name: Test installation
      run: |
        bash install.sh
        test -f ~/.local/bin/fplaunch-manage
        test -f ~/.local/bin/fplaunch-generate

  test-debian:
    name: Test on Debian
    runs-on: ubuntu-latest
    container:
      image: debian:bookworm
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        apt-get update
        apt-get install -y flatpak dialog bash git
        flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
    
    - name: Run test suite
      run: |
        cd tests
        bash run_all_tests.sh
    
    - name: Test installation
      run: |
        bash install.sh
        test -f ~/.local/bin/fplaunch-manage

  test-arch:
    name: Test on Arch Linux
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        pacman -Syu --noconfirm flatpak dialog bash git
        flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
    
    - name: Run test suite
      run: |
        cd tests
        bash run_all_tests.sh
    
    - name: Test installation
      run: |
        bash install.sh
        test -f ~/.local/bin/fplaunch-manage
