name: CI

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]

jobs:
  shellcheck:
    name: ShellCheck Linting
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Run ShellCheck
      uses: ludeeus/action-shellcheck@master
      with:
        scandir: '.'
        severity: warning
        ignore_paths: '.git .github tests/fixtures build system_detection_fix.patch'
        ignore_names: 'README.md fplaunch_completion.bash improved_system_detection.sh optimized_system_detection.sh test_name_clashes.sh test_real_world_clashes.sh'

  test-ubuntu:
    name: Test on Ubuntu
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y flatpak dialog
        sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
    
    - name: Run test suite
      run: |
        cd tests
        bash run_all_tests.sh
    
    - name: Test installation
      run: |
        # Create test user for installation (CI runs as root)
        useradd -m -s /bin/bash testuser
        su - testuser -c "CI=1 bash $PWD/install.sh"
        # Verify installation
        su - testuser -c "test -f ~/.local/bin/fplaunch-manage"
        su - testuser -c "test -f ~/.local/bin/fplaunch-generate"
        su - testuser -c "test -f ~/.local/bin/fplaunch-setup-systemd"
    
    - name: Test management commands
      run: |
        ~/.local/bin/fplaunch-manage --help
        ~/.local/bin/fplaunch-manage list
        ~/.local/bin/fplaunch-manage list-blocked

  test-fedora:
    name: Test on Fedora
    runs-on: ubuntu-latest
    container:
      image: fedora:latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        dnf install -y flatpak dialog bash python3
        flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
    
    - name: Run test suite
      run: |
        cd tests
        bash run_all_tests.sh
    
    - name: Test installation
      run: |
        # Create test user for installation (CI runs as root)
        useradd -m -s /bin/bash testuser
        su - testuser -c "CI=1 bash $PWD/install.sh"
        # Verify installation
        su - testuser -c "test -f ~/.local/bin/fplaunch-manage"
        su - testuser -c "test -f ~/.local/bin/fplaunch-generate"

  test-debian:
    name: Test on Debian
    runs-on: ubuntu-latest
    container:
      image: debian:bookworm
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        apt-get update
        apt-get install -y flatpak dialog bash git python3
        flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
    
    - name: Run test suite
      run: |
        cd tests
        bash run_all_tests.sh
    
    - name: Test installation
      run: |
        # Create test user for installation (CI runs as root)
        useradd -m -s /bin/bash testuser
        su - testuser -c "CI=1 bash $PWD/install.sh"
        # Verify installation
        su - testuser -c "test -f ~/.local/bin/fplaunch-manage"

  test-arch:
    name: Test on Arch Linux
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        pacman -Syu --noconfirm flatpak dialog bash git python
        flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
    
    - name: Run test suite
      run: |
        cd tests
        bash run_all_tests.sh
    
    - name: Test installation
      run: |
        # Create test user for installation (CI runs as root)
        useradd -m -s /bin/bash testuser
        su - testuser -c "CI=1 bash $PWD/install.sh"
        # Verify installation
        su - testuser -c "test -f ~/.local/bin/fplaunch-manage"
