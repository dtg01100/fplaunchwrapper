name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  pre-release-tests:
    name: Pre-Release Testing
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'

    - name: Install UV package manager
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: Install dependencies
      run: |
        uv pip install --system -e .
        uv pip install --system pytest pytest-mock

    - name: Run comprehensive test suite
      run: |
        echo "ðŸ§ª Running comprehensive pre-release tests..."

        # Run safety validation
        python3 test_integration_safety.py

        # Run performance tests
        python3 test_performance_simple.py

        # Run Python unit tests
        python3 -c "
        import sys
        sys.path.insert(0, '.')
        from tests.python.test_safe_constructor import TestSafeConstructorValidation
        test_instance = TestSafeConstructorValidation()
        test_instance.test_wrapper_generator_constructor()
        test_instance.test_wrapper_manager_constructor()
        test_instance.test_wrapper_cleanup_constructor()
        test_instance.test_app_launcher_constructor()
        test_instance.test_systemd_setup_constructor()
        test_instance.test_complete_isolation_validation()
        print('âœ… All Python tests passed!')
        "

        # Run edge case tests
        python3 -c "
        import sys
        sys.path.insert(0, '.')
        from tests.python.test_edge_cases_focused import TestInputValidationEdgeCases
        test_instance = TestInputValidationEdgeCases()
        test_instance.test_empty_and_none_inputs()
        test_instance.test_extremely_long_inputs()
        print('âœ… Edge case tests passed!')
        "

        echo "ðŸŽ‰ All pre-release tests passed!"

  build-packages:
    name: Build Distribution Packages
    runs-on: ubuntu-latest
    needs: pre-release-tests

    steps:
    - uses: actions/checkout@v4

    - name: Set version from tag
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version $VERSION"
    
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential devscripts debhelper rpm texinfo
    
    - name: Build Debian package
      run: |
        ./packaging/build-deb.sh ${{ steps.version.outputs.VERSION }}
    
    - name: Build RPM package
      run: |
        ./packaging/build-rpm.sh ${{ steps.version.outputs.VERSION }}
    
    - name: Create tarball
      run: |
        VERSION=${{ steps.version.outputs.VERSION }}
        mkdir -p fplaunchwrapper-$VERSION
        cp -r *.sh *.bash fplaunch-* lib/ examples/ README.md RELEASE_*.md fplaunchwrapper-$VERSION/
        tar -czf fplaunchwrapper-$VERSION.tar.gz fplaunchwrapper-$VERSION
    
    - name: Generate release notes
      id: release_notes
      run: |
        if [ -f "RELEASE_v${{ steps.version.outputs.VERSION }}.md" ]; then
          cat "RELEASE_v${{ steps.version.outputs.VERSION }}.md" > release_notes.md
        else
          echo "Release v${{ steps.version.outputs.VERSION }}" > release_notes.md
          echo "" >> release_notes.md
          echo "See [README.md](README.md) for installation and usage instructions." >> release_notes.md
        fi
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          *.deb
          *.rpm
          *.tar.gz
        body_path: release_notes.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: packages
        path: |
          *.deb
          *.rpm
          *.tar.gz
