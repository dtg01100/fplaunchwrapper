#!/bin/bash
# Generated by fplaunchwrapper

NAME="ignition"
ID="io.github.flattool.Ignition"
PREF_DIR="$HOME/.config/flatpak-wrappers"
PREF_FILE="$PREF_DIR/$NAME.pref"
SCRIPT_BIN_DIR="test_bins"

mkdir -p "$PREF_DIR"

if [ "$1" = "--help" ]; then
    echo "Wrapper for $NAME"
    echo "Usage: $0 [args]"
    echo "Run '$0 --fpwrapper-help' for more options."
    exit 0
elif [ "$1" = "--fpwrapper-help" ]; then
    echo "Wrapper for $NAME"
    echo "Flatpak ID: $ID"
    pref=$(cat "$PREF_FILE" 2>/dev/null || echo "none")
    echo "Current preference: $pref"
    echo ""
    echo "Available options:"
    echo "  --help                 Show basic usage"
    echo "  --fpwrapper-help       Show this detailed help"
    echo "  --fpwrapper-info       Show wrapper info"
    echo "  --fpwrapper-config-dir Show Flatpak data directory"
    echo "  --fpwrapper-set-override [system|flatpak]  Set launch preference"
    echo ""
    echo "Examples:"
    echo "  $0 --fpwrapper-info"
    echo "  cd $($0 --fpwrapper-config-dir)"
    echo "  $0 --fpwrapper-set-override system"
    exit 0
elif [ "$1" = "--fpwrapper-info" ]; then
    echo "Wrapper for $NAME"
    echo "Flatpak ID: $ID"
    pref=$(cat "$PREF_FILE" 2>/dev/null || echo "none")
    echo "Preference: $pref"
    echo "Usage: $0 [args]"
    exit 0
elif [ "$1" = "--fpwrapper-config-dir" ]; then
    config_dir="$HOME/.var/app/$ID"
    echo "$config_dir"
    exit 0
elif [ "$1" = "--fpwrapper-set-override" ]; then
    if [ -z "$2" ]; then
        echo "Choose override:"
        echo "1. system"
        echo "2. flatpak"
        read -r -p "Choice (1/2): " choice
        if [ "$choice" = "1" ]; then
            pref="system"
        elif [ "$choice" = "2" ]; then
            pref="flatpak"
        else
            echo "Invalid choice"
            exit 1
        fi
    else
        pref="$2"
    fi
    if [ "$pref" = "system" ] || [ "$pref" = "flatpak" ]; then
        echo "$pref" > "$PREF_FILE"
        echo "Preference set to $pref"
    else
        echo "Invalid override: use 'system' or 'flatpak'"
    fi
    exit 0
fi

if [ -f "$PREF_FILE" ]; then
    PREF=$(cat "$PREF_FILE")
else
    PREF=""
fi

# Check for system command at launch time
SYSTEM_EXISTS=false
if command -v "$NAME" >/dev/null 2>&1; then
    CMD_PATH=$(which "$NAME")
    if [[ "$CMD_PATH" != "$SCRIPT_BIN_DIR/$NAME" ]]; then
        SYSTEM_EXISTS=true
    fi
fi

if [ "$PREF" = "system" ]; then
    if [ "$SYSTEM_EXISTS" = true ]; then
        exec "$NAME" "$@"
    else
        # System command gone, fall back to flatpak
        PREF="flatpak"
        echo "flatpak" > "$PREF_FILE"
        exec flatpak run io.github.flattool.Ignition "$@"
    fi
elif [ "$PREF" = "flatpak" ]; then
    exec flatpak run io.github.flattool.Ignition "$@"
else
    # No pref set
    if [ "$SYSTEM_EXISTS" = true ]; then
        echo "Multiple options for '$NAME':"
        echo "1. System package ($CMD_PATH)"
        echo "2. Flatpak app ($ID)"
        read -r -p "Choose (1/2, default 1): " choice
        choice=${choice:-1}
        if [ "$choice" = "1" ]; then
            PREF="system"
            echo "$PREF" > "$PREF_FILE"
            exec "$NAME" "$@"
        elif [ "$choice" = "2" ]; then
            PREF="flatpak"
            echo "$PREF" > "$PREF_FILE"
            exec flatpak run io.github.flattool.Ignition "$@"
        else
            echo "Invalid choice, defaulting to system."
            PREF="system"
            echo "$PREF" > "$PREF_FILE"
            exec "$NAME" "$@"
        fi
    else
        PREF="flatpak"
        echo "$PREF" > "$PREF_FILE"
        exec flatpak run io.github.flattool.Ignition "$@"
    fi
fi
