#!/usr/bin/env bash
# Generated by fplaunchwrapper

NAME="test_app"
ID="test_app"
PREF_DIR="config"
PREF_FILE="$PREF_DIR/$NAME.pref"
# Hook/script locations
HOOK_DIR="$PREF_DIR/scripts/$NAME"
PRE_SCRIPT="$HOOK_DIR/pre-launch.sh"
POST_SCRIPT="$HOOK_DIR/post-run.sh"
# Load configured script paths from config file if available
CONFIG_SCRIPT_PRE=""
CONFIG_SCRIPT_POST=""
if command -v python3 >/dev/null 2>&1; then
    CONFIG_SCRIPT_PRE=$(python3 -c "
from lib.config_manager import create_config_manager
config = create_config_manager()
prefs = config.get_app_preferences('test_app')
print(prefs.pre_launch_script or '')
" 2>/dev/null)
    CONFIG_SCRIPT_POST=$(python3 -c "
from lib.config_manager import create_config_manager
config = create_config_manager()
prefs = config.get_app_preferences('test_app')
print(prefs.post_launch_script or '')
" 2>/dev/null)
fi
# Use configured script path if valid
if [ -n "$CONFIG_SCRIPT_PRE" ] && [ -x "$CONFIG_SCRIPT_PRE" ]; then
    PRE_SCRIPT="$CONFIG_SCRIPT_PRE"
fi
if [ -n "$CONFIG_SCRIPT_POST" ] && [ -x "$CONFIG_SCRIPT_POST" ]; then
    POST_SCRIPT="$CONFIG_SCRIPT_POST"
fi
# Load environment variables if present
ENV_FILE="$PREF_DIR/$NAME.env"
if [ -f "$ENV_FILE" ]; then
    # shellcheck disable=SC1090
    source "$ENV_FILE"
fi
SCRIPT_BIN_DIR="/workspaces/fplaunchwrapper/bin"
ONE_SHOT_PREF=""

mkdir -p "$PREF_DIR"

# Interactive check
is_interactive() {
    [ "${FPWRAPPER_FORCE:-}" = "interactive" ] || ([ -t 0 ] && [ -t 1 ] && [ "${FPWRAPPER_FORCE:-}" != "desktop" ])
}

# System binary discovery
set_system_info() {
    SYSTEM_EXISTS=false
    CMD_PATH=""
    if command -v "$NAME" >/dev/null 2>&1; then
        CMD_PATH=$(command -v "$NAME")
        if [ "$CMD_PATH" != "$SCRIPT_BIN_DIR/$NAME" ]; then
            SYSTEM_EXISTS=true
        else
            CMD_PATH=""
        fi
    fi
}

# Run single launch
run_single_launch() {
    local choice="$1"
    shift

    # Run pre-launch script if present
    run_pre_launch_script "$@"

    if [ "$choice" = "system" ]; then
        if [ "$SYSTEM_EXISTS" = true ]; then
            "$NAME" "$@"
            local exit_code=$?
            run_post_launch_script "$exit_code" "system"
            exit "$exit_code"
        else
            echo "System binary not found; falling back to flatpak for this launch." >&2
            flatpak run "$ID" "$@"
            local exit_code=$?
            run_post_launch_script "$exit_code" "flatpak"
            exit "$exit_code"
        fi
    else
        flatpak run "$ID" "$@"
        local exit_code=$?
        run_post_launch_script "$exit_code" "flatpak"
        exit "$exit_code"
    fi
}

# Pre-launch script execution
run_pre_launch_script() {
    if [ -x "$PRE_SCRIPT" ]; then
        "$PRE_SCRIPT" "$NAME" "$ID" "$source" "$@"
    fi
}

# Post-launch script execution
run_post_launch_script() {
    local exit_code="$1"
    local source="$2"  # "system" or "flatpak"
    
    if [ -x "$POST_SCRIPT" ]; then
        (
            export FPWRAPPER_EXIT_CODE="$exit_code"
            export FPWRAPPER_SOURCE="$source"
            export FPWRAPPER_WRAPPER_NAME="$NAME"
            export FPWRAPPER_APP_ID="$ID"
            "$POST_SCRIPT" "$NAME" "$ID" "$source" "$exit_code" "$@"
        ) 2>&1 || echo "[fplaunchwrapper] Warning: Post-launch script failed with exit code $?" >&2
    fi
}

set_pre_script() {
    local script_path="$1"
    if [ -z "$script_path" ]; then
        echo "Usage: $NAME --fpwrapper-set-pre-script <script_path>" >&2
        exit 1
    fi
    if [ ! -f "$script_path" ]; then
        echo "Script not found: $script_path" >&2
        exit 1
    fi
    mkdir -p "$HOOK_DIR"
    cp "$script_path" "$PRE_SCRIPT"
    chmod +x "$PRE_SCRIPT"
    echo "Pre-launch script set to $script_path"
    exit 0
}

set_post_script() {
    local script_path="$1"
    if [ -z "$script_path" ]; then
        echo "Usage: $NAME --fpwrapper-set-post-script <script_path>" >&2
        exit 1
    fi
    if [ ! -f "$script_path" ]; then
        echo "Script not found: $script_path" >&2
        exit 1
    fi
    mkdir -p "$HOOK_DIR"
    cp "$script_path" "$POST_SCRIPT"
    chmod +x "$POST_SCRIPT"
    echo "Post-run script set to $script_path"
    exit 0
}

# One-shot launch
if [ "$1" = "--fpwrapper-launch" ]; then
    if [ -z "$2" ]; then
        echo "Usage: $NAME --fpwrapper-launch [system|flatpak]" >&2
        exit 1
    fi
    case "$2" in
        system|flatpak)
            ONE_SHOT_PREF="$2"
            shift 2
            ;;
        *)
            echo "Invalid choice for --fpwrapper-launch: $2 (use system|flatpak)" >&2
            exit 1
            ;;
    esac
fi

# Force interactive mode
if [ "$1" = "--fpwrapper-force-interactive" ]; then
    FPWRAPPER_FORCE="interactive"
    shift
fi

# Discover system info
set_system_info

# Check for wrapper options first (before interactive logic)
# Help command
if [ "$1" = "--fpwrapper-help" ]; then
    echo "Wrapper for $NAME"
    echo "Flatpak ID: $ID"
    pref=$(cat "$PREF_FILE" 2>/dev/null || echo "none")
    echo "Current preference: $pref"
    echo ""
    echo "Available options:"
    echo "  --help                 Show basic usage"
    echo "  --fpwrapper-help       Show detailed help"
    echo "  --fpwrapper-info       Show wrapper info"
    echo "  --fpwrapper-config-dir Show Flatpak data directory"
    echo "  --fpwrapper-sandbox-info Show Flatpak sandbox details"
    echo "  --fpwrapper-edit-sandbox Edit Flatpak permissions"
    echo "  --fpwrapper-sandbox-yolo Grant all permissions (dangerous)"
    echo "  --fpwrapper-sandbox-reset Reset sandbox to defaults"
    echo "  --fpwrapper-run-unrestricted Run with unrestricted permissions"
    echo "  --fpwrapper-set-override [system|flatpak] Set launch preference"
    echo "  --fpwrapper-set-preference [system|flatpak] Alias for --fpwrapper-set-override"
    echo "  --fpwrapper-launch [system|flatpak] Launch once without saving"
    echo "  --fpwrapper-force-interactive Force interactive mode (even in scripts)"
    echo "  --fpwrapper-set-pre-script <script> Set pre-launch script"
    echo "  --fpwrapper-set-post-script <script> Set post-run script"
    echo "  --fpwrapper-remove-pre-script Remove pre-launch script"
    echo "  --fpwrapper-remove-post-script Remove post-run script"
    exit 0
fi

# Info command
if [ "$1" = "--fpwrapper-info" ]; then
    echo "Wrapper for $NAME"
    echo "Flatpak ID: $ID"
    pref=$(cat "$PREF_FILE" 2>/dev/null || echo "none")
    echo "Preference: $pref"
    echo "Usage: ./$NAME [args]"
    exit 0
fi

# Config directory
if [ "$1" = "--fpwrapper-config-dir" ]; then
    config_dir="${XDG_DATA_HOME:-$HOME/.local/share}/applications/$ID"
    echo "$config_dir"
    exit 0
fi

# Sandbox info
if [ "$1" = "--fpwrapper-sandbox-info" ]; then
    if command -v flatpak >/dev/null 2>&1; then
        flatpak info "$ID"
    else
        echo "Flatpak not available"
    fi
    exit 0
fi

# Edit sandbox permissions - Full interactive implementation
if [ "$1" = "--fpwrapper-edit-sandbox" ]; then
    if ! command -v flatpak >/dev/null 2>&1; then
        echo "Flatpak not available - cannot edit sandbox"
        exit 1
    fi
    
    if ! is_interactive; then
        echo "Error: Sandbox editing requires interactive CLI" >&2
        exit 1
    fi
    
    # Check if Flatseal is installed
    if flatpak list --app 2>/dev/null | grep -q "com.github.tchx84.Flatseal"; then
        echo "Launching Flatseal for $ID..."
        flatpak run com.github.tchx84.Flatseal "$ID" 2>/dev/null &
        exit 0
    fi
    
    # Check if user previously declined Flatseal installation
    FLATSEAL_DECLINED_MARKER="${XDG_CONFIG_HOME:-$HOME/.config}/fplaunchwrapper/flatseal_declined"
    
    if [ ! -f "$FLATSEAL_DECLINED_MARKER" ]; then
        echo ""
        echo "Flatseal (GUI permissions editor) not found."
        read -r -p "Would you like to install it? [y/N] " install_flatseal
        case "$install_flatseal" in
            [yY]|[yY][eE][sS])
                echo "Installing Flatseal..."
                if flatpak install flathub com.github.tchx84.Flatseal -y; then
                    echo "Flatseal installed successfully. Launching..."
                    flatpak run com.github.tchx84.Flatseal "$ID" 2>/dev/null &
                    exit 0
                else
                    echo "Failed to install Flatseal. Falling back to CLI editor."
                fi
                ;;
            *)
                echo "Flatseal installation declined. Using CLI editor."
                mkdir -p "$(dirname "$FLATSEAL_DECLINED_MARKER")"
                touch "$FLATSEAL_DECLINED_MARKER"
                ;;
        esac
    fi
    
    # CLI fallback - Interactive permission editor
    echo ""
    echo "=========================================="
    echo "Sandbox Permissions Editor for $ID"
    echo "=========================================="
    echo ""
    
    # Show current overrides
    echo "Current permissions:"
    if flatpak override --show --user "$ID" 2>/dev/null | grep -q "^\["; then
        flatpak override --show --user "$ID" 2>/dev/null | grep -v "^\[" || echo "  (none)"
    else
        echo "  (using defaults)"
    fi
    echo ""
    
    # Built-in presets
    PRESET_DEVELOPMENT="--filesystem=home --filesystem=host --device=dri --socket=x11 --socket=wayland --share=ipc"
    PRESET_MEDIA="--device=dri --socket=pulseaudio --socket=wayland --socket=x11 --share=ipc --filesystem=~/Music --filesystem=~/Videos"
    PRESET_NETWORK="--share=network --share=ipc --socket=x11 --socket=wayland"
    PRESET_MINIMAL="--share=ipc"
    PRESET_GAMING="--device=dri --device=input --socket=pulseaudio --socket=wayland --socket=x11 --share=ipc --share=network --filesystem=~/Games"
    PRESET_OFFLINE="--device=dri --socket=pulseaudio --socket=wayland --socket=x11 --share=ipc --filesystem=home"
    
    # Load custom presets from config
    CUSTOM_PRESETS=()
    if command -v python3 >/dev/null 2>&1; then
        while IFS= read -r preset_name; do
            [ -n "$preset_name" ] && CUSTOM_PRESETS+=("$preset_name")
        done < <(python3 -m fplaunch.config_manager list-presets 2>/dev/null)
    fi
    
    # Display menu
    echo "Select an option:"
    echo "  1) Manual entry (line-by-line)"
    echo "  2) Apply preset: Development (filesystem access, graphics)"
    echo "  3) Apply preset: Media (audio/video/graphics)"
    echo "  4) Apply preset: Network (networking + IPC)"
    echo "  5) Apply preset: Minimal (IPC only)"
    echo "  6) Apply preset: Gaming (graphics, input, audio, network)"
    echo "  7) Apply preset: Offline (local files, graphics, audio)"
    echo "  8) Remove specific permission"
    
    menu_option=9
    for custom_preset in "${CUSTOM_PRESETS[@]}"; do
        echo "  $menu_option) Apply custom preset: $custom_preset"
        ((menu_option++))
    done
    
    echo "  $menu_option) Show current overrides"
    ((menu_option++))
    echo "  $menu_option) Reset to defaults"
    ((menu_option++))
    echo "  $menu_option) Cancel"
    echo ""
    
    read -r -p "Choose option: " choice
    
    case "$choice" in
        1)
            # Manual entry
            echo ""
            echo "Enter permissions one per line (empty line to finish)"
            echo "Examples:"
            echo "  --filesystem=home"
            echo "  --filesystem=host"
            echo "  --device=dri"
            echo "  --device=all"
            echo "  --share=network"
            echo "  --share=ipc"
            echo "  --socket=x11"
            echo "  --socket=wayland"
            echo "  --socket=pulseaudio"
            echo ""
            
            PERMISSIONS=()
            while true; do
                read -r -p "Permission: " perm
                [ -z "$perm" ] && break
                
                # Validate format
                if [[ "$perm" =~ ^--[a-z-]+(=.+)?$ ]]; then
                    PERMISSIONS+=("$perm")
                else
                    echo "  Warning: Invalid format (must start with --, e.g., --filesystem=home)"
                fi
            done
            
            if [ ${#PERMISSIONS[@]} -eq 0 ]; then
                echo "No permissions entered."
                exit 0
            fi
            
            echo ""
            echo "Permissions to apply:"
            printf '  %s\n' "${PERMISSIONS[@]}"
            echo ""
            read -r -p "Apply these ${#PERMISSIONS[@]} permissions? [y/N] " confirm
            
            if [[ "$confirm" =~ ^[yY]$ ]]; then
                for perm in "${PERMISSIONS[@]}"; do
                    if flatpak override --user "$ID" "$perm" 2>/dev/null; then
                        echo "  ✓ Applied: $perm"
                    else
                        echo "  ✗ Failed: $perm"
                    fi
                done
                echo ""
                echo "Permissions updated. Final state:"
                flatpak override --show --user "$ID" 2>/dev/null | grep -v "^\[" || echo "  (none)"
            else
                echo "Cancelled."
            fi
            ;;
        2|3|4|5|6|7)
            # Built-in presets
            case "$choice" in
                2) PRESET_NAME="Development"; PRESET_PERMS=($PRESET_DEVELOPMENT) ;;
                3) PRESET_NAME="Media"; PRESET_PERMS=($PRESET_MEDIA) ;;
                4) PRESET_NAME="Network"; PRESET_PERMS=($PRESET_NETWORK) ;;
                5) PRESET_NAME="Minimal"; PRESET_PERMS=($PRESET_MINIMAL) ;;
                6) PRESET_NAME="Gaming"; PRESET_PERMS=($PRESET_GAMING) ;;
                7) PRESET_NAME="Offline"; PRESET_PERMS=($PRESET_OFFLINE) ;;
            esac
            
            echo ""
            echo "Preset: $PRESET_NAME"
            echo "Permissions:"
            printf '  %s\n' "${PRESET_PERMS[@]}"
            echo ""
            read -r -p "Apply these ${#PRESET_PERMS[@]} permissions? [y/N] " confirm
            
            if [[ "$confirm" =~ ^[yY]$ ]]; then
                for perm in "${PRESET_PERMS[@]}"; do
                    if flatpak override --user "$ID" "$perm" 2>/dev/null; then
                        echo "  ✓ Applied: $perm"
                    else
                        echo "  ✗ Failed: $perm"
                    fi
                done
                echo ""
                echo "Permissions updated. Final state:"
                flatpak override --show --user "$ID" 2>/dev/null | grep -v "^\[" || echo "  (none)"
            else
                echo "Cancelled."
            fi
            ;;
        8)
            # Remove specific permission
            echo ""
            echo "Current permissions to remove:"
            CURRENT_PERMS=$(flatpak override --show --user "$ID" 2>&1 | grep -v "^\[" | grep -v "No overrides" | awk '{print $$1}')
            
            if [ -z "$CURRENT_PERMS" ]; then
                echo "  No custom permissions set"
                exit 0
            fi
            
            echo "$CURRENT_PERMS" | nl -ba
            
            read -r -p "Enter number of permission to remove (or empty to cancel): " perm_number
            if [ -z "$perm_number" ]; then
                echo "Cancelled."
                exit 0
            fi
            
            if [[ "$perm_number" =~ ^[0-9]+$ ]]; then
                PERM_TO_REMOVE=$(echo "$CURRENT_PERMS" | sed -n "${perm_number}p")
                if [ -n "$PERM_TO_REMOVE" ]; then
                    echo ""
                    read -r -p "Remove permission: $PERM_TO_REMOVE? [y/N] " confirm
                    if [[ "$confirm" =~ ^[yY]$ ]]; then
                        # Remove the permission by resetting that specific override type
                        # This is a workaround since flatpak doesn't support direct removal
                        echo "Removing $PERM_TO_REMOVE..."
                        # Get current overrides without this permission
                        NEW_OVERRIDES=$(flatpak override --show --user "$ID" 2>&1 | grep -v "^\[" | grep -v "$PERM_TO_REMOVE")
                        # Reset all overrides and apply remaining ones
                        flatpak override --user --reset "$ID" 2>/dev/null
                        if [ -n "$NEW_OVERRIDES" ]; then
                            while IFS= read -r line; do
                                if [ -n "$line" ]; then
                                    flatpak override --user "$ID" "$line" 2>/dev/null
                                fi
                            done <<< "$NEW_OVERRIDES"
                        fi
                        echo "Permission removed successfully."
                        echo ""
                        echo "Updated permissions:"
                        flatpak override --show --user "$ID" 2>&1 | grep -v "^\[" || echo "  (using default permissions)"
                    else
                        echo "Cancelled."
                    fi
                else
                    echo "Invalid permission number"
                fi
            else
                echo "Invalid input"
            fi
            ;;
        *)
            # Check if it's a custom preset
            custom_index=$((choice - 9))
            if [ "$custom_index" -ge 0 ] && [ "$custom_index" -lt ${#CUSTOM_PRESETS[@]} ]; then
                PRESET_NAME="${CUSTOM_PRESETS[$custom_index]}"
                
                # Load preset permissions
                PRESET_PERMS=()
                if command -v python3 >/dev/null 2>&1; then
                    while IFS= read -r perm; do
                        [ -n "$perm" ] && PRESET_PERMS+=("$perm")
                    done < <(python3 -m fplaunch.config_manager get-preset "$PRESET_NAME" 2>/dev/null)
                fi
                
                if [ ${#PRESET_PERMS[@]} -eq 0 ]; then
                    echo "Failed to load preset: $PRESET_NAME"
                    exit 1
                fi
                
                echo ""
                echo "Custom preset: $PRESET_NAME"
                echo "Permissions:"
                printf '  %s\n' "${PRESET_PERMS[@]}"
                echo ""
                read -r -p "Apply these ${#PRESET_PERMS[@]} permissions? [y/N] " confirm
                
                if [[ "$confirm" =~ ^[yY]$ ]]; then
                    for perm in "${PRESET_PERMS[@]}"; do
                        if flatpak override --user "$ID" "$perm" 2>/dev/null; then
                            echo "  ✓ Applied: $perm"
                        else
                            echo "  ✗ Failed: $perm"
                        fi
                    done
                    echo ""
                    echo "Permissions updated. Final state:"
                    flatpak override --show --user "$ID" 2>/dev/null | grep -v "^\[" || echo "  (none)"
                else
                    echo "Cancelled."
                fi
            elif [ "$choice" = "$((menu_option - 3))" ]; then
                # Show current overrides
                echo ""
                echo "Current overrides for $ID:"
                flatpak override --show --user "$ID" 2>/dev/null || echo "  (using defaults)"
            elif [ "$choice" = "$((menu_option - 2))" ]; then
                # Reset to defaults
                echo ""
                echo "Current overrides:"
                flatpak override --show --user "$ID" 2>/dev/null | grep -v "^\[" || echo "  (none)"
                echo ""
                echo "WARNING: This will reset ALL permissions to defaults."
                echo "This action cannot be undone!"
                echo ""
                read -r -p "Type 'yes' to confirm reset: " confirm
                
                if [ "$confirm" = "yes" ]; then
                    if flatpak override --user --reset "$ID" 2>/dev/null; then
                        echo "Permissions reset to defaults."
                    else
                        echo "Failed to reset permissions."
                        exit 1
                    fi
                else
                    echo "Reset cancelled."
                fi
            else
                # Cancel
                echo "Cancelled."
            fi
            ;;
    esac
    exit 0
fi

# Manage hook scripts
if [ "$1" = "--fpwrapper-set-pre-script" ]; then
    set_pre_script "$2"
fi

if [ "$1" = "--fpwrapper-set-post-script" ]; then
    set_post_script "$2"
fi

if [ "$1" = "--fpwrapper-remove-pre-script" ]; then
    if [ -f "$PRE_SCRIPT" ]; then
        rm "$PRE_SCRIPT"
        echo "Pre-launch script removed"
    else
        echo "No pre-launch script configured"
    fi
    exit 0
fi

if [ "$1" = "--fpwrapper-remove-post-script" ]; then
    if [ -f "$POST_SCRIPT" ]; then
        rm "$POST_SCRIPT"
        echo "Post-run script removed"
    else
        echo "No post-run script configured"
    fi
    exit 0
fi

# Set override (allow alias for preference)
if [ "$1" = "--fpwrapper-set-override" ] || [ "$1" = "--fpwrapper-set-preference" ]; then
    if [ -z "$2" ]; then
        echo "Usage: $0 --fpwrapper-set-override [system|flatpak]" >&2
        exit 1
    fi
    case "$2" in
        system|flatpak)
            echo "$2" > "$PREF_FILE"
            echo "Preference set to: $2"
            exit 0
            ;;
        *)
            echo "Invalid preference: $2 (use system|flatpak)" >&2
            exit 1
            ;;
    esac
fi

# Sandbox reset
if [ "$1" = "--fpwrapper-sandbox-reset" ]; then
    if command -v flatpak >/dev/null 2>&1; then
        flatpak override --reset "$ID"
        echo "Sandbox reset to defaults"
    else
        echo "Flatpak not available - would reset sandbox"
    fi
    exit 0
fi

# Sandbox yolo
if [ "$1" = "--fpwrapper-sandbox-yolo" ]; then
    if command -v flatpak >/dev/null 2>&1; then
        # Check if interactive (for safety warning)
        if is_interactive; then
            echo ""
            echo "⚠️  WARNING: YOLO mode grants ALL possible permissions!"
            echo "This completely disables the Flatpak sandbox and is extremely dangerous."
            echo "Only use this if you trust the application completely."
            echo ""
            read -r -p "Type 'YES' to confirm (case-sensitive): " confirm
            if [ "$confirm" != "YES" ]; then
                echo "Cancelled YOLO mode"
                exit 0
            fi
        fi
        
        # Apply all possible permissions
        flatpak override --user "$ID"             --filesystem=host             --device=all             --share=all             --socket=all             --system-talk-name=             --talk-name=
        echo "YOLO mode applied - ALL permissions granted (sandbox disabled)"
    else
        echo "Flatpak not available - would grant all permissions"
    fi
    exit 0
fi

# Run unrestricted
if [ "$1" = "--fpwrapper-run-unrestricted" ]; then
    if command -v flatpak >/dev/null 2>&1; then
        shift
        exec flatpak run --no-sandbox "$ID" "$@"
    else
        echo "Flatpak not available - would run unrestricted"
        exit 0
    fi
fi

# Non-interactive bypass
if ! is_interactive; then
    if [ -n "$ONE_SHOT_PREF" ]; then
        run_single_launch "$ONE_SHOT_PREF" "$@"
    fi

    # Ensure pre-launch hooks run in non-interactive flows
    run_pre_launch_script "$@"

    # Find next executable in PATH
    IFS=: read -ra PATH_DIRS <<< "$PATH"
    for dir in "${PATH_DIRS[@]}"; do
        [ -z "$dir" ] && continue
        if [ -x "$dir/$NAME" ] && [ "$dir/$NAME" != "$SCRIPT_BIN_DIR/$NAME" ]; then
            "$dir/$NAME" "$@"
            exit_code=$?
            run_post_launch_script "$exit_code" "system"
            exit "$exit_code"
        fi
    done

    # Run flatpak
    run_pre_launch_script "$@"
    flatpak run "$ID" "$@"
    exit_code=$?
    run_post_launch_script "$exit_code" "flatpak"
    exit "$exit_code"
fi

# For now, just run the interactive logic

# Load preference
if [ -f "$PREF_FILE" ]; then
    PREF=$(cat "$PREF_FILE")
else
    PREF=""
fi

# Check for system command
SYSTEM_EXISTS=false
CMD_PATH=""
if command -v "$NAME" >/dev/null 2>&1; then
    CMD_PATH=$(command -v "$NAME")
    [ "$CMD_PATH" != "$SCRIPT_BIN_DIR/$NAME" ] && SYSTEM_EXISTS=true
fi

# Interactive launch logic
if [ "$PREF" = "system" ]; then
    if [ "$SYSTEM_EXISTS" = true ]; then
        run_pre_launch_script "$@"
        "$NAME" "$@"
        exit_code=$?
        run_post_launch_script "$exit_code" "system"
        exit "$exit_code"
    else
        # System command gone, fall back to flatpak
        echo "flatpak" > "$PREF_FILE"
        run_pre_launch_script "$@"
        flatpak run "$ID" "$@"
        exit_code=$?
        run_post_launch_script "$exit_code" "flatpak"
        exit "$exit_code"
    fi
elif [ "$PREF" = "flatpak" ]; then
    run_pre_launch_script "$@"
    flatpak run "$ID" "$@"
    exit_code=$?
    run_post_launch_script "$exit_code" "flatpak"
    exit "$exit_code"
else
    # No preference set - show interactive prompt
    if is_interactive && [ "$SYSTEM_EXISTS" = true ]; then
        echo "Multiple options for '$NAME':"
        echo "1. System package ($CMD_PATH)"
        echo "2. Flatpak app ($ID)"
        echo ""
        read -r -p "Choose (1/2, default 1): " choice
        choice=${choice:-1}

        if [ "$choice" = "1" ]; then
            PREF="system"
        elif [ "$choice" = "2" ]; then
            PREF="flatpak"
        else
            echo "Invalid choice '$choice', using default: system"
            PREF="system"
        fi

        echo "$PREF" > "$PREF_FILE"
        run_pre_launch_script "$@"
        if [ "$PREF" = "system" ]; then
            "$NAME" "$@"
        else
            flatpak run "$ID" "$@"
        fi
        exit_code=$?
        run_post_launch_script "$exit_code" "$PREF"
        exit "$exit_code"
    else
        # Non-interactive or only flatpak available
        if [ "$SYSTEM_EXISTS" = true ]; then
            PREF="system"
            echo "$PREF" > "$PREF_FILE"
            run_pre_launch_script "$@"
            "$NAME" "$@"
            exit_code=$?
            run_post_launch_script "$exit_code" "system"
            exit "$exit_code"
        else
            PREF="flatpak"
            echo "$PREF" > "$PREF_FILE"
            run_pre_launch_script "$@"
            flatpak run "$ID" "$@"
            exit_code=$?
            run_post_launch_script "$exit_code" "flatpak"
            exit "$exit_code"
        fi
    fi
fi
