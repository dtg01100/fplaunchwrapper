#!/usr/bin/env bash

# Cleanup script for Flatpak Launch Wrappers
# Safely removes generated wrappers, aliases, config, user services, and completion drop-ins

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/flatpak-wrappers"
UNIT_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/systemd/user"
BIN_DIR_DEFAULT="$HOME/.local/bin"
BIN_DIR_FILE="$CONFIG_DIR/bin_dir"
BIN_DIR="$BIN_DIR_DEFAULT"

if [ -f "$BIN_DIR_FILE" ]; then
  BIN_DIR="$(cat "$BIN_DIR_FILE" 2>/dev/null || echo "$BIN_DIR_DEFAULT")"
fi

DRY_RUN=false
ASSUME_YES=false

usage() {
  cat << EOF
Usage: $(basename "$0") [options]

Options:
  -y, --yes           Proceed without confirmation
      --dry-run       Show what would be removed without deleting
      --bin-dir DIR   Override wrapper bin directory (default: $BIN_DIR)
  -h, --help          Show this help and exit

This script removes per-user artifacts created by fplaunchwrapper:
- Generated wrapper scripts (identified by header marker)
- Alias symlinks pointing to those wrappers
- User config at $CONFIG_DIR
- systemd user units (flatpak-wrappers.*) and disables them
- Cron job entries created by fplaunch-setup-systemd fallback
- Bash completion drop-in at ~/.bashrc.d/fplaunch_completion.bash
- Man pages at ~/.local/share/man (from manual install)

It does NOT uninstall the system package. Run this BEFORE removing the package
if you want to clean your home directory.
EOF
}

# Parse args
while [ $# -gt 0 ]; do
  case "$1" in
    -y|--yes)
      ASSUME_YES=true; shift ;;
    --dry-run)
      DRY_RUN=true; shift ;;
    --bin-dir)
      BIN_DIR="${2:-}"; shift 2 ;;
    -h|--help)
      usage; exit 0 ;;
    *)
      echo "Unknown option: $1" >&2
      usage; exit 1 ;;
  esac
done

confirm() {
  if $ASSUME_YES; then return 0; fi
  read -r -p "$1 (y/N): " ans
  [[ "$ans" =~ ^[Yy]$ ]]
}

log_do() {
  local desc="$1"; shift
  echo "$desc"
  if ! $DRY_RUN; then
    "$@"
  fi
}

# Summary of actions
echo "About to clean per-user artifacts for fplaunchwrapper:"
cat << SUM
- Wrapper directory: $BIN_DIR
- Config directory:  $CONFIG_DIR
- systemd units in:  $UNIT_DIR
- Bash completion:   ~/.bashrc.d/fplaunch_completion.bash
- Man pages:         ~/.local/share/man
SUM

if ! confirm "Proceed with cleanup?"; then
  echo "Aborted. No changes made."
  exit 0
fi

# 1) Stop/disable user services and remove units
if command -v systemctl >/dev/null 2>&1; then
  log_do "Stopping user services (if running)..." true
  $DRY_RUN || systemctl --user stop flatpak-wrappers.path flatpak-wrappers.timer flatpak-wrappers.service >/dev/null 2>&1 || true
  log_do "Disabling user services..." true
  $DRY_RUN || systemctl --user disable flatpak-wrappers.path flatpak-wrappers.timer flatpak-wrappers.service >/dev/null 2>&1 || true
fi

for unit in flatpak-wrappers.service flatpak-wrappers.path flatpak-wrappers.timer; do
  if [ -f "$UNIT_DIR/$unit" ]; then
    log_do "Removing unit: $UNIT_DIR/$unit" rm -f "$UNIT_DIR/$unit"
  fi
done

if command -v systemctl >/dev/null 2>&1; then
  log_do "Reloading user systemd daemon..." true
  $DRY_RUN || systemctl --user daemon-reload >/dev/null 2>&1 || true
fi

# 2) Remove cron entry lines that reference fplaunch-generate
if command -v crontab >/dev/null 2>&1; then
  current_cron="$($DRY_RUN || crontab -l 2>/dev/null || true)"
  if echo "$current_cron" | grep -q "fplaunch-generate"; then
    echo "Removing cron entries that reference fplaunch-generate"
    if ! $DRY_RUN; then
      echo "$current_cron" | grep -v "fplaunch-generate" | crontab -
    fi
  fi
fi

# 3) Remove generated wrappers and alias symlinks
if [ -d "$BIN_DIR" ]; then
  shopt -s nullglob
  for f in "$BIN_DIR"/*; do
    if [ -f "$f" ] && head -n 5 "$f" | grep -q '^# Generated by fplaunchwrapper$'; then
      log_do "Removing wrapper: $f" rm -f "$f"
    elif [ -L "$f" ]; then
      target="$(readlink -f "$f" 2>/dev/null || true)"
      if [ -n "$target" ] && [ -f "$target" ] && head -n 5 "$target" | grep -q '^# Generated by fplaunchwrapper$'; then
        log_do "Removing alias symlink: $f" rm -f "$f"
      fi
    fi
  done
  shopt -u nullglob
  # Remove installed scripts if present (from manual install)
  for script in fplaunch-manage fplaunch-generate fplaunch-setup-systemd fplaunch-cleanup; do
    if [ -f "$BIN_DIR/$script" ]; then
      log_do "Removing script: $BIN_DIR/$script" rm -f "$BIN_DIR/$script"
    fi
  done
  # Remove lib directory if installed (from manual install)
  # Manual install creates $BIN_DIR/lib, package install creates /usr/lib/fplaunchwrapper
  if [ -d "$BIN_DIR/lib" ]; then
    log_do "Removing library directory: $BIN_DIR/lib" rm -rf "$BIN_DIR/lib"
  fi
fi

# 4) Remove bash completion drop-in
if [ -f "$HOME/.bashrc.d/fplaunch_completion.bash" ]; then
  log_do "Removing bash completion drop-in: ~/.bashrc.d/fplaunch_completion.bash" rm -f "$HOME/.bashrc.d/fplaunch_completion.bash"
fi

# 5) Remove man pages (from manual install)
MAN_DIR="$HOME/.local/share/man"
if [ -d "$MAN_DIR" ]; then
  for manpage in "$MAN_DIR/man1/fplaunch-"*.1 "$MAN_DIR/man7/fplaunchwrapper."*; do
    if [ -f "$manpage" ]; then
      log_do "Removing man page: $manpage" rm -f "$manpage"
    fi
  done
  # Clean up empty man directories
  if ! $DRY_RUN; then
    rmdir "$MAN_DIR/man1" 2>/dev/null || true
    rmdir "$MAN_DIR/man7" 2>/dev/null || true
    rmdir "$MAN_DIR" 2>/dev/null || true
  fi
fi

# 6) Remove config directory
if [ -d "$CONFIG_DIR" ]; then
  log_do "Removing config directory: $CONFIG_DIR" rm -rf "$CONFIG_DIR"
fi

echo "Cleanup complete."
